<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Verdica Trial Test</title>
</head>
<body style="font-family: Arial; max-width: 600px; margin: 20px auto;">
  <h1>Verdica Trial Test</h1>

  <div>
    <button onclick="loadTrials()">üîÑ Trials laden</button>
    <button onclick="checkTrials()">‚öñÔ∏è Neue Trials pr√ºfen</button>
  </div>

  <h2>Trials</h2>
  <div id="trials"></div>

  <script>
    const API_URL = "http://localhost:4000";

    async function loadTrials() {
      const res = await fetch(`${API_URL}/api/trials`);
      const data = await res.json();
      if (data.ok) {
        const container = document.getElementById("trials");
        container.innerHTML = "";
        data.trials.forEach(t => {
          const div = document.createElement("div");
          div.style.border = "1px solid #ccc";
          div.style.padding = "10px";
          div.style.margin = "10px 0";
          div.innerHTML = `
            <p><b>ID:</b> ${t.id}</p>
            <p><b>Accused:</b> ${t.users?.username || "?"}</p>
            <p><b>Post:</b> ${t.posts?.content || "?"}</p>
            <p><b>Status:</b> ${t.status}</p>
            <button onclick="assignJudges('${t.id}')">üë©‚Äç‚öñÔ∏è Judges zuweisen</button>
            <button onclick="vote('${t.id}','audience','guilty')">üëé Audience Guilty</button>
            <button onclick="vote('${t.id}','audience','not_guilty')">üëç Audience Not Guilty</button>
            <button onclick="showResults('${t.id}')">üìä Ergebnisse</button>
            <div id="results-${t.id}" style="margin-top:10px; font-size:0.9em; color:#333;"></div>
          `;
          container.appendChild(div);
        });
      }
    }

    async function checkTrials() {
      const res = await fetch(`${API_URL}/api/trials/check`, { method: "POST" });
      const data = await res.json();
      alert("Neue Trials erstellt: " + data.created);
      loadTrials();
    }

    async function assignJudges(trialId) {
      const res = await fetch(`${API_URL}/api/trials/${trialId}/assign-judges`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ count: 3 })
      });
      const data = await res.json();
      if (data.ok) {
        alert("Judges zugewiesen: " + data.judges.length);
      } else {
        alert("Fehler: " + data.error);
      }
    }

    async function vote(trialId, role, vote) {
      const userId = prompt("User-ID eingeben (z. B. aus Users-Tabelle):");
      if (!userId) return;
      const res = await fetch(`${API_URL}/api/trials/${trialId}/vote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, role, vote })
      });
      const data = await res.json();
      if (data.ok) {
        alert("Vote gespeichert!");
      } else {
        alert("Fehler: " + data.error);
      }
    }

    async function showResults(trialId) {
      const res = await fetch(`${API_URL}/api/trials/${trialId}/results`);
      const data = await res.json();
      if (data.ok) {
        const div = document.getElementById("results-" + trialId);
        div.innerHTML = `
          Votes: ${data.votes.length}<br/>
          Guilty: ${data.tally.guilty} | Not Guilty: ${data.tally.not_guilty}
        `;
      }
    }

    // Direkt laden
    loadTrials();
  </script>
</body>
</html>
